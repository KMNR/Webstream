webstreamd
=========

A cron-based daemon for recording webstreams

webstreamd is a tool to capture a webstream on a schedule. It stores the recordings and can automatically clean them up after a certain number of days.

How It Works
---------

webstreamd is a series of components which work together. AS part of installation it will create:

* A command to generate a crontab to record shows
* A command that is run to create the recording
* A command that is used to clean up recordings

It will also create a command to fetch the schedule from KMNR.org, but unless you're a kmnr-ite you're probably not interested in that.

Requirements
----------

webstreamed was developed for Python 2.6 or greater. webstreamd is bundled with a copy of [icecream](http://icecream.sourceforge.net) to perform the actual recording, and so requires a copy of perl to be available on the system. It also requires a cron installation that provides an `/etc/cron.d` folder.

Installation & Configuration
===========

Webstreamd can be installed by using the `setup.py`. webstreamd expects to be installed by root, since it creates files in `/etc` and `/usr/bin`.

```
python setup.py install
```

After installing webstreamd is configured, by default, for KMNR's recordings.

Configuration file
------------

webstreamd creates a configuration file in `/etc/webstream.d/webstreamd.conf` with the following available options:

**stream**
* streamurl : The location of the stream that will be recorded. In theory this can be a .pls or .m3u stream url.

**recording**
* leadin : The amount of time in minutes that will be recorded before the show is scheduled to start (for early starts etc)
* leadout : The amount of time in minutes that will be recorded after the show is scheduled to end (for run-over etc)
* directory : The directory where the recordings will be made.
* keepfor : The number of days that you will keep the recording for in days.

**schedule**
* schedule/schedule : The location of the schedule json file.

webstreamd comes bundled with an example schedule file: You can rewrite to this schedule file as you desire and webstreamd will create a new crontab based on that schedule file (see cron)

Schedule
------------
Webstreamd comes with an example schedule file. The schedule is a json file that describes what shows should be recorded and when. The structure of this document is a list of dictionaries that each describe a show. Here is an example schedule, pretty printed:

```
[
  {"title": "Metal^3",
   "start_time": "00:00:00",
   "start_day": 2,
   "duration": 7200.0},
  {"title": "#handledit",
   "start_time": "22:00:00",
   "start_day": 1,
   "duration": 7200.0}
]
```

As you can see each dictionary in the list has the following keys:

* title : the title of the show, used to name and sort the files.
* start_time : the time the show starts (without leadin) in HH:MM:SS format
* start_day : the day the show starts on as an iso weekday (1 - Monday, 7 Sunday)
* duration : the length of the recording to make in seconds.

Cron
------------
webstreamd comes with a cron that pulls the schedule from kmnr.org and updates the recording cron every fifteen minutes. By default, this file is installed in `/etc/cron.d/webstreamd`. You can write your own script to replace the KMNR fetcher to dynamically schedule webstreamd, or you can remove the fetch component if you do not need to update your schedule dynamically:

**Using your own fetcher:**

In `/etc/cron.d/webstreamd`

```
*/15 * * * * root MY-FETCH-SCRIPT > /etc/webstream.d/schedule.json && webstreamd-crontab > /etc/cron.d/webstreamd-schedule
@daily root webstreamd-clean
```

**No fetcher:**

In `/etc/cron.d/webstreamd`

```
*/15 * * * * root webstreamd-crontab > /etc/cron.d/webstreamd-schedule
@daily root webstreamd-clean
```

When the `webstreamd-crontab` command runs it generates a new schedule cron at `/etc/cron.d/webstreamd-schedule`. This file is autogenerated. Near the top of the document is a comment indicating when `webstreamd-crontab` last updated that file.

Extra Info
============

Limitations
------------

Since it uses cron, webstreamd cannot record a show if the system is rebooted during the recording or the `webstream-schedule` crontab adds the show after it has started.

Command Reference
------------

`webstreamd-crontab [CONFIGFILE]` : Generates a crontab based on CONFIGFILE, using `/etc/webstream.d/webstreamd.conf` if one is not specified.

`webstreamd-record FILE DURATION STREAM` : Records STREAM to FILE, for DURATION minutes. FILE should be specified without an extension.

`webstreamd-clean [CONFIGFILE]` : Removes recordings based on CONFIGFILE, using `/etc/webstream.d/webstreamd.conf` if one is not specified. Looks for the date specified as part of the file name to determine the age of a recording.

`webstreamd-kmnr` : Fetches the current show schedule from kmnr.org and converts it to the webstreamd schedule format.
